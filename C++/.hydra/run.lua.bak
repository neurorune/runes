#!/usr/bin/env lua

local DIR = "."
local BIN_DIR = ".magic/bin"
local COMPILER = "g++"
local FLAGS = "-std=c++20 -Wall -Wextra -O0 -g"

os.execute("mkdir -p " .. BIN_DIR)

print("ğŸ‘€ Watching C++ saves, deletes, renamesâ€¦")
print("ğŸ“¦ Binaries â†’ " .. BIN_DIR)

-- Track rename cookies
local rename_from = {}

local watch_cmd = string.format(
  "inotifywait -m -e close_write -e delete -e delete_self -e moved_from -e moved_to " ..
  "--format '%%e %%c %%f' %s",
  DIR
)

local watcher = io.popen(watch_cmd)

for line in watcher:lines() do
  local events, cookie, filename = line:match("^(.-) (%d+) (.+)$")

  if not filename or not filename:match("%.cpp$") then
    goto continue
  end

  local base = filename:gsub("%.cpp$", "")
  local bin = BIN_DIR .. "/" .. base

  -- ğŸ—‘ï¸ DELETE
  if events:match("DELETE") or events:match("DELETE_SELF") then
    os.execute("rm -f " .. bin)
    print("ğŸ—‘ï¸  Removed binary: " .. bin)

    -- âœï¸ SAVE â†’ COMPILE
  elseif events:match("CLOSE_WRITE") then
    os.execute("clear")
    print("ğŸ› ï¸  Compiling " .. filename)
    print(string.rep("â”€", 30))

    local cmd = string.format("%s %s %s -o %s", COMPILER, FLAGS, filename, bin)
    local pipe = io.popen(cmd .. " 2>&1")
    local output = pipe:read("*a")
    local ok, _, code = pipe:close()

    if ok and code == 0 then
      print("âœ… Build success")
      print(string.rep("â”€", 30))
      os.execute(bin)
    else
      print("âŒ Build failed")
      print(string.rep("â”€", 30))
      print(output)
    end

    -- ğŸ”„ RENAME FROM
  elseif events:match("MOVED_FROM") then
    rename_from[cookie] = filename

    -- ğŸ” RENAME TO
  elseif events:match("MOVED_TO") then
    local old = rename_from[cookie]
    if old then
      local old_bin = BIN_DIR .. "/" .. old:gsub("%.cpp$", "")
      local new_bin = BIN_DIR .. "/" .. filename:gsub("%.cpp$", "")

      if os.execute("[ -f " .. old_bin .. " ]") then
        os.execute("mv " .. old_bin .. " " .. new_bin)
        print("ğŸ” Renamed binary: " .. old_bin .. " â†’ " .. new_bin)
      end

      rename_from[cookie] = nil
    end
  end

  ::continue::
end
