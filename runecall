#!/usr/bin/env lua

-- ----------------------------------
-- Resolve runes root dynamically
-- ----------------------------------
local function dirname(path)
  return path:match("(.*/)")
end

local function realpath(cmd)
  local f = io.popen(cmd)
  local p = f:read("*l")
  f:close()
  return p
end

-- path to this script
local SELF = realpath("readlink -f " .. arg[0])
local RUNES_ROOT = dirname(SELF)

-- ----------------------------------
-- Language map
-- ----------------------------------
local runes = {
  c          = "C/.croc",
  cpp        = "C++/.hydra",
  javascript = "JavaScript/.bun",
  python     = "Python/.waves",
  rust       = "Rust/.ratatuya",
}

-- ----------------------------------
-- Input
-- ----------------------------------
local lang = arg[1]

if not lang then
  print("‚ùå Unknown language\n")
  print("Available runes:")
  for k, _ in pairs(runes) do
    print("  ‚Ä¢ " .. k)
  end
  os.exit(1)
end

local rune_path = runes[lang]

if not rune_path then
  print("‚ùå Unknown language\n")
  print("Available runes:")
  for k, _ in pairs(runes) do
    print("  ‚Ä¢ " .. k)
  end
  os.exit(1)
end

-- ----------------------------------
-- Paths
-- ----------------------------------
local src = RUNES_ROOT .. rune_path
local dst = "./" .. rune_path:match("/(.+)$")

-- ----------------------------------
-- Sanity check
-- ----------------------------------
local test = io.open(src)
if not test then
  print("‚ùå Rune source not found:")
  print("   " .. src)
  os.exit(1)
end
test:close()

-- ----------------------------------
-- Copy + run
-- ----------------------------------
local copy_cmd = string.format("cp -r '%s' .", src)
local ok = os.execute(copy_cmd)

if ok then
  os.execute("lua " .. dst .. "/run.lua")
else
  print("üí• Failed to summon rune")
end
